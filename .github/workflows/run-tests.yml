name: Run tests with coverage

on:
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    branches: [ "main" ]

permissions:
  contents: read
  pull-requests: write
  checks: write


jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Run unit tests
        run: mvn clean package

      - name: Run integration tests
        run: mvn verify -DskipUTs=true

      - name: Add coverage to PR
        id: jacoco
        uses: madrapps/jacoco-report@v1.7.2
        with:
          paths: target/site/jacoco/jacoco.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 40
          min-coverage-changed-files: 60

      - name: Post a message in a channel
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: "*GitHub Action build result*: ${{ job.status }}
            PR: ${{ github.event.pull_request.html_url || github.event.head_commit.url }}
            Overall Coverage: ${{ steps.jacoco.outputs.coverage-overall-formatted }}
            Changed Files Coverage: ${{ steps.jacoco.outputs.coverage-changed-files-formatted }}"

            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: |
                    *GitHub Action build result*: `${{ job.status }}`
                    *PR:* ${{ github.event.pull_request.html_url || github.event.head_commit.url }}

                    *Overall Coverage:* `${{ steps.jacoco.outputs.coverage-overall }}%`
                    *Changed Files Coverage:* `${{ steps.jacoco.outputs.coverage-changed-files }}%`
